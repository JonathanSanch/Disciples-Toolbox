import{Memoirist as e}from"memoirist";import{mergeHook as t,getSchemaValidator as r,getResponseSchemaValidator as s,mergeDeep as o,checksum as i,mergeLifeCycle as n,filterGlobalHook as a,asGlobal as h}from"./utils";import{composeErrorHandler as d,composeGeneralHandler as u,composeHandler as f}from"./compose";import{ws as c}from"./ws";import{isProduction as l,ERROR_CODE as p}from"./error";import{createDynamicErrorHandler as m,createDynamicHandler as y}from"./dynamic-handle";export default class g{config;dependencies={};store={};meta={schema:Object.create(null),defs:Object.create(null),exposed:Object.create(null)};decorators={};event={start:[],request:[],parse:[],transform:[],beforeHandle:[],afterHandle:[],onResponse:[],error:[],stop:[]};server=null;$schema=null;error={};router=new e;routes=[];staticRouter={handlers:[],variables:"",map:{},all:""};wsRouter;dynamicRouter=new e;lazyLoadModules=[];path="";constructor(e){this.config={forceErrorEncapsulation:!1,prefix:"",aot:!0,strictPath:!1,scoped:!1,...e,seed:e?.seed===void 0?"":e?.seed}}add(e,o,i,n,{allowMeta:a=!1,skipPrefix:h=!1}={allowMeta:!1,skipPrefix:!1}){o=""===o?o:47===o.charCodeAt(0)?o:`/${o}`,this.config.prefix&&!h&&(o=this.config.prefix+o);let d=this.meta.defs;if(n?.type)switch(n.type){case"text":n.type="text/plain";break;case"json":n.type="application/json";break;case"formdata":n.type="multipart/form-data";break;case"urlencoded":n.type="application/x-www-form-urlencoded";break;case"arrayBuffer":n.type="application/octet-stream"}let u={body:r(n?.body??this.$schema?.body,{dynamic:!this.config.aot,models:d}),headers:r(n?.headers??this.$schema?.headers,{dynamic:!this.config.aot,models:d,additionalProperties:!0}),params:r(n?.params??this.$schema?.params,{dynamic:!this.config.aot,models:d}),query:r(n?.query??this.$schema?.query,{dynamic:!this.config.aot,models:d}),response:s(n?.response??this.$schema?.response,{dynamic:!this.config.aot,models:d})},c=t(this.event,n),l=o.endsWith("/")?o.slice(0,o.length-1):o+"/";if(!1===this.config.aot){this.dynamicRouter.add(e,o,{validator:u,hooks:c,content:n?.type,handle:i}),!1===this.config.strictPath&&this.dynamicRouter.add(e,l,{validator:u,hooks:c,content:n?.type,handle:i}),this.routes.push({method:e,path:o,composed:null,handler:i,hooks:c});return}let p=f({path:o,method:e,hooks:c,validator:u,handler:i,handleError:this.handleError,meta:a?this.meta:void 0,onRequest:this.event.request,config:this.config});if(this.routes.push({method:e,path:o,composed:p,handler:i,hooks:c}),-1===o.indexOf(":")&&-1===o.indexOf("*")){let t=this.staticRouter.handlers.length;this.staticRouter.handlers.push(p),this.staticRouter.variables+=`const st${t} = staticRouter.handlers[${t}]
`,this.staticRouter.map[o]||(this.staticRouter.map[o]={code:""}),"ALL"===e?this.staticRouter.map[o].all=`default: return st${t}(ctx)
`:this.staticRouter.map[o].code+=`case '${e}': return st${t}(ctx)
`,this.config.strictPath||(this.staticRouter.map[l]||(this.staticRouter.map[l]={code:""}),"ALL"===e?this.staticRouter.map[l].all=`default: return st${t}(ctx)
`:this.staticRouter.map[l].code+=`case '${e}': return st${t}(ctx)
`)}else this.router.add(e,o,p),this.config.strictPath||this.router.add(e,o.endsWith("/")?o.slice(0,o.length-1):o+"/",p)}onStart(e){return this.on("start",e),this}onRequest(e){return this.on("request",e),this}onParse(e){return this.on("parse",e),this}onTransform(e){return this.on("transform",e),this}onBeforeHandle(e){return this.on("beforeHandle",e),this}onAfterHandle(e){return this.on("afterHandle",e),this}onResponse(e){return this.on("response",e),this}addError(e,t){if("string"==typeof e&&t)return t.prototype[p]=e,this;for(let[t,r]of Object.entries(e))r.prototype[p]=t;return this}onError(e){return this.on("error",e),this}onStop(e){return this.on("stop",e),this}on(e,t){switch(t=h(t),e){case"start":this.event.start.push(t);break;case"request":this.event.request.push(t);break;case"response":this.event.onResponse.push(t);break;case"parse":this.event.parse.splice(this.event.parse.length-1,0,t);break;case"transform":this.event.transform.push(t);break;case"beforeHandle":this.event.beforeHandle.push(t);break;case"afterHandle":this.event.afterHandle.push(t);break;case"error":this.event.error.push(t);break;case"stop":this.event.stop.push(t)}return this}group(e,r,s){let i=new g({...this.config,prefix:""});i.store=this.store,this.wsRouter&&i.use(c());let n="object"==typeof r,a=(n?s:r)(i);return this.decorators=o(this.decorators,i.decorators),a.event.request.length&&(this.event.request=[...this.event.request,...a.event.request]),a.event.onResponse.length&&(this.event.onResponse=[...this.event.onResponse,...a.event.onResponse]),this.model(a.meta.defs),Object.values(i.routes).forEach(({method:s,path:o,handler:h,hooks:d})=>{if(o=this.config.prefix+e+o,n){let e=i.wsRouter?.find("subscribe",o);if(e){let e=i.wsRouter.history.find(([e,t])=>o===t);if(!e)return;return this.ws(o,e[2])}this.add(s,o,h,t(r,{...d,error:d.error?Array.isArray(d.error)?[...d.error,...a.event.error]:[d.error,...a.event.error]:a.event.error}))}else{let e=i.wsRouter?.find("subscribe",o);if(e){let e=i.wsRouter.history.find(([e,t])=>o===t);if(!e)return;return this.ws(o,e[2])}this.add(s,o,h,t(d,{error:a.event.error}),{skipPrefix:!0})}}),i.wsRouter&&this.wsRouter&&i.wsRouter.history.forEach(([t,r,s])=>{"/"===(r=this.config.prefix+e+r)?this.wsRouter?.add(t,e,s):this.wsRouter?.add(t,`${e}${r}`,s)}),this}guard(e,r){if(!r)return this.event=n(this.event,e),this.$schema={body:e.body,headers:e.headers,params:e.params,query:e.query,response:e.response},this;let s=new g;s.store=this.store,this.wsRouter&&s.use(c());let i=r(s);return this.decorators=o(this.decorators,s.decorators),i.event.request.length&&(this.event.request=[...this.event.request,...i.event.request]),i.event.onResponse.length&&(this.event.onResponse=[...this.event.onResponse,...i.event.onResponse]),this.model(i.meta.defs),Object.values(s.routes).forEach(({method:r,path:o,handler:n,hooks:a})=>{let h=s.wsRouter?.find("subscribe",o);if(h){let e=s.wsRouter.history.find(([e,t])=>o===t);if(!e)return;return this.ws(o,e[2])}this.add(r,o,n,t(e,{...a,error:a.error?Array.isArray(a.error)?[...a.error,...i.event.error]:[a.error,...i.event.error]:i.event.error}))}),s.wsRouter&&this.wsRouter&&s.wsRouter.history.forEach(([e,t,r])=>{this.wsRouter?.add(e,t,r)}),this}use(e){let r=e=>{if("function"==typeof e){let t=e(this);return t instanceof Promise?(this.lazyLoadModules.push(t.then(e=>e.compile())),this):t}let r=e.config.scoped;r||(this.decorators=o(this.decorators,e.decorators),this.state(e.store),this.model(e.meta.defs),this.addError(e.error));let{config:{name:s,seed:h}}=e;if(Object.values(e.routes).forEach(({method:r,path:s,handler:o,hooks:i})=>{let n=e.wsRouter?.find("subscribe",s);if(n){let t=e.wsRouter.history.find(([e,t])=>s===t);if(!t)return;return this.ws(s,t[2])}this.add(r,s,o,t(i,{error:e.event.error}))}),!r){if(s){s in this.dependencies||(this.dependencies[s]=[]);let t=void 0!==h?i(s+JSON.stringify(h)):0;if(this.dependencies[s].some(e=>t===e))return this;this.dependencies[s].push(t),this.event=n(this.event,a(e.event),t)}else this.event=n(this.event,a(e.event))}return this};return e instanceof Promise?(this.lazyLoadModules.push(e.then(e=>"function"==typeof e?e(this):"function"==typeof e.default?e.default(this):r(e.default)).then(e=>e.compile())),this):r(e)}mount(e,t){if("function"==typeof e||0===e.length||"/"===e){let r="function"==typeof e?e:t,s=async({request:e,path:t})=>r(new Request("http://a.cc"+t,e));return this.all("/",s,{type:"none"}),this.all("/*",s,{type:"none"}),this}let r=e.length,s=async({request:e,path:s})=>t(new Request("http://a.cc"+s.slice(r),e));return this.all(e,s,{type:"none"}),this.all(e+(e.endsWith("/")?"*":"/*"),s,{type:"none"}),this}get(e,t,r){for(let s of("string"==typeof e&&(e=[e]),e))this.add("GET",s,t,r);return this}post(e,t,r){for(let s of("string"==typeof e&&(e=[e]),e))this.add("POST",s,t,r);return this}put(e,t,r){for(let s of("string"==typeof e&&(e=[e]),e))this.add("PUT",s,t,r);return this}patch(e,t,r){for(let s of("string"==typeof e&&(e=[e]),e))this.add("PATCH",s,t,r);return this}delete(e,t,r){for(let s of("string"==typeof e&&(e=[e]),e))this.add("DELETE",s,t,r);return this}options(e,t,r){for(let s of("string"==typeof e&&(e=[e]),e))this.add("OPTIONS",s,t,r);return this}all(e,t,r){for(let s of("string"==typeof e&&(e=[e]),e))this.add("ALL",s,t,r);return this}head(e,t,r){for(let s of("string"==typeof e&&(e=[e]),e))this.add("HEAD",s,t,r);return this}trace(e,t,r){for(let s of("string"==typeof e&&(e=[e]),e))this.add("TRACE",s,t,r);return this}connect(e,t,r){for(let s of("string"==typeof e&&(e=[e]),e))this.add("CONNECT",s,t,r);return this}ws(e,t){if(!this.wsRouter)throw Error("Can't find WebSocket. Please register WebSocket plugin first by importing 'elysia/ws'");for(let s of("string"==typeof e&&(e=[e]),e))this.wsRouter.add("subscribe",s,t),this.get(s,e=>{if(!this.server?.upgrade(e.request,{headers:"function"==typeof t.upgrade?t.upgrade(e):t.upgrade,data:{...e,id:Date.now(),headers:e.request.headers.toJSON(),message:r(t?.body,{models:this.meta.defs}),transformMessage:t.transform?Array.isArray(t.transformMessage)?t.transformMessage:[t.transformMessage]:[]}}))return e.set.status=400,"Expected a websocket connection"},{beforeHandle:t.beforeHandle,transform:t.transform,headers:t?.headers,params:t?.params,query:t?.query});return this}route(e,t,r,{config:s,...o}={config:{allowMeta:!1}}){for(let i of("string"==typeof t&&(t=[t]),t))this.add(e,i,r,o,s);return this}state(e,t){return"object"==typeof e?this.store=o(this.store,e):e in this.store||(this.store[e]=t),this}decorate(e,t){return"object"==typeof e?this.decorators=o(this.decorators,e):e in this.decorators||(this.decorators[e]=t),this}derive(e){return e.$elysia="derive",this.onTransform(e)}schema(e){let t=this.meta.defs;return this.$schema={body:r(e.body,{models:t}),headers:r(e?.headers,{models:t,additionalProperties:!0}),params:r(e?.params,{models:t}),query:r(e?.query,{models:t}),response:r(e?.response,{models:t})},this}compile(){return this.fetch=this.config.aot?u(this):y(this),"function"==typeof this.server?.reload&&this.server.reload({...this.server,fetch:this.fetch}),this}handle=async e=>this.fetch(e);fetch=e=>(this.fetch=this.config.aot?u(this):y(this))(e);handleError=async(e,t,r)=>(this.handleError=this.config.aot?d(this):m(this))(e,t,r);outerErrorHandler=e=>new Response(e.message,{status:e?.status??500});listen=(e,t)=>{if(!Bun)throw Error("Bun to run");if(this.compile(),"string"==typeof e&&Number.isNaN(e=+e.trim()))throw Error("Port must be a numeric value");let r=this.fetch,s="object"==typeof e?{development:!l,...this.config.serve,...e,fetch:r,error:this.outerErrorHandler}:{development:!l,...this.config.serve,port:e,fetch:r,error:this.outerErrorHandler};if("undefined"==typeof Bun)throw Error(".listen() is designed to run on Bun only. If you are running Elysia in other environment please use a dedicated plugin or export the handler via Elysia.fetch");this.server=Bun?.serve(s);for(let e=0;e<this.event.start.length;e++)this.event.start[e](this);return t&&t(this.server),Promise.all(this.lazyLoadModules).then(()=>{Bun?.gc(!0)}),this};stop=async()=>{if(!this.server)throw Error("Elysia isn't running. Call `app.listen` to start the server.");this.server.stop();for(let e=0;e<this.event.stop.length;e++)await this.event.stop[e](this)};get modules(){return Promise.all(this.lazyLoadModules)}model(e,t){return"object"==typeof e?Object.entries(e).forEach(([e,t])=>{e in this.meta.defs||(this.meta.defs[e]=t)}):this.meta.defs[e]=t,this}}export{mapResponse,mapCompactResponse,mapEarlyResponse}from"./handler";export{t}from"./custom-types";export{ws}from"./ws";export{getSchemaValidator,mergeDeep,mergeHook,mergeObjectArray,getResponseSchemaValidator}from"./utils";export{ParseError,NotFoundError,ValidationError,InternalServerError}from"./error";export{g as Elysia};