import{Memoirist as e}from"memoirist";import{ValidationError as r}from"../error";let s=e=>{let r=e.indexOf("/",10),s=e.indexOf("?",r);return -1===s?e.slice(r):e.slice(r,s)};export class ElysiaWS{raw;data;isSubscribed;constructor(e){this.raw=e,this.data=e.data,this.isSubscribed=e.isSubscribed}publish(e,r,s){return"object"==typeof r&&(r=JSON.stringify(r)),this.raw.publish(e,r,s),this}publishToSelf(e,r,s){return"object"==typeof r&&(r=JSON.stringify(r)),this.raw.publish(e,r,s),this}send(e){return"object"==typeof e&&(e=JSON.stringify(e)),this.raw.send(e),this}subscribe(e){return this.raw.subscribe(e),this}unsubscribe(e){return this.raw.unsubscribe(e),this}cork(e){return this.raw.cork(e),this}close(){return this.raw.close(),this}}export const ws=t=>i=>{i.wsRouter||(i.wsRouter=new e);let a=i.wsRouter;return i.config.serve||(i.config.serve={websocket:{...t,open(e){if(!e.data)return;let r=s(e?.data.request.url);if(!r)return;let t=a.find("subscribe",r)?.store;t&&t.open&&t.open(new ElysiaWS(e))},message(e,t){if(!e.data)return;let i=s(e?.data.request.url);if(!i)return;let n=a.find("subscribe",i)?.store;if(!n?.message)return;t=t.toString();let u=t.charCodeAt(0);if(47===u||123===u)try{t=JSON.parse(t)}catch(e){}else Number.isNaN(+t)||(t=+t);for(let r=0;r<e.data.transformMessage.length;r++){let s=e.data.transformMessage[r](t);void 0!==s&&(t=s)}if(e.data.message?.Check(t)===!1)return void e.send(new r("message",e.data.message,t).cause);n.message(new ElysiaWS(e),t)},close(e,r,t){if(!e.data)return;let i=s(e?.data.request.url);if(!i)return;let n=a.find("subscribe",i)?.store;n&&n.close&&n.close(new ElysiaWS(e),r,t)},drain(e){if(!e.data)return;let r=s(e?.data.request.url);if(!r)return;let t=a.find("subscribe",r)?.store;t&&t.drain&&t.drain(new ElysiaWS(e))}}}),i.decorate("publish",i.server?.publish).onStart(e=>{e.decorators.publish=e.server?.publish})};