import{NotFoundError as e,ValidationError as t,ERROR_CODE as a}from"./error";import{mapEarlyResponse as r,mapResponse as s}from"./handler";import{parse as n}from"fast-querystring";export const createDynamicHandler=a=>async o=>{let i;let l={status:200,headers:{}};a.decorators?((i=a.decorators).request=o,i.set=l,i.store=a.store):i={set:l,store:a.store,request:o};let f=o.url,c=f.indexOf("/",11),d=f.indexOf("?",c+1),w=-1===d?f.substring(c):f.substring(c,d);try{let c;for(let e=0;e<a.event.request.length;e++){let t=a.event.request[e],s=t(i);if(s instanceof Promise&&(s=await s),s=r(s,l))return s}let m=a.dynamicRouter.find(o.method,w)??a.dynamicRouter.find("ALL",w);if(!m)throw new e;let{handle:u,hooks:h,validator:p,content:y}=m.store;if("GET"!==o.method){if(y)switch(y){case"application/json":c=await o.json();break;case"text/plain":c=await o.text();break;case"application/x-www-form-urlencoded":c=n(await o.text());break;case"application/octet-stream":c=await o.arrayBuffer();break;case"multipart/form-data":c={};let e=await o.formData();for(let t of e.keys()){if(c[t])continue;let a=e.getAll(t);1===a.length?c[t]=a[0]:c[t]=a}}else{let e=o.headers.get("content-type");if(e){let t=e.indexOf(";");-1!==t&&(e=e.slice(0,t));for(let t=0;t<a.event.parse.length;t++){let r=a.event.parse[t](i,e);if(r instanceof Promise&&(r=await r),r){c=r;break}}if(void 0===c)switch(e){case"application/json":c=await o.json();break;case"text/plain":c=await o.text();break;case"application/x-www-form-urlencoded":c=n(await o.text());break;case"application/octet-stream":c=await o.arrayBuffer();break;case"multipart/form-data":c={};let r=await o.formData();for(let e of r.keys()){if(c[e])continue;let t=r.getAll(e);1===t.length?c[e]=t[0]:c[e]=t}}}}}i.body=c,i.params=m?.params||{},i.query=-1===d?{}:n(f.substring(d+1));for(let e=0;e<h.transform.length;e++){let t=h.transform[e](i);"derive"===h.transform[e].$elysia?t instanceof Promise?Object.assign(i,await t):Object.assign(i,t):t instanceof Promise&&await t}if(p){if(p.headers){let e={};for(let t in o.headers)e[t]=o.headers.get(t);if(!1===p.headers.Check(e))throw new t("header",p.headers,e)}if(p.params?.Check(i.params)===!1)throw new t("params",p.params,i.params);if(p.query?.Check(i.query)===!1)throw new t("query",p.query,i.query);if(p.body?.Check(c)===!1)throw new t("body",p.body,c)}for(let e=0;e<h.beforeHandle.length;e++){let t=h.beforeHandle[e](i);if(t instanceof Promise&&(t=await t),void 0!==t){for(let e=0;e<h.afterHandle.length;e++){let a=h.afterHandle[e](i,t);a instanceof Promise&&(a=await a),a&&(t=a)}let e=r(t,i.set);if(e)return e}}let g=u(i);if(g instanceof Promise&&(g=await g),h.afterHandle.length)for(let e=0;e<h.afterHandle.length;e++){let a=h.afterHandle[e](i,g);a instanceof Promise&&(a=await a);let s=r(a,i.set);if(void 0!==s){let e=p?.response?.[g.status];if(e?.Check(s)===!1)throw new t("response",e,s);return s}}else{let e=p?.response?.[g.status];if(e?.Check(g)===!1)throw new t("response",e,g)}return s(g,i.set)}catch(e){return e.status&&(l.status=e.status),a.handleError(o,e,l)}finally{for(let e of a.event.onResponse)await e(i)}};export const createDynamicErrorHandler=e=>async(t,r,n={headers:{}})=>{for(let o=0;o<e.event.error.length;o++){let i=e.event.error[o]({request:t,code:r.code??r[a]??"UNKNOWN",error:r,set:n});if(i instanceof Promise&&(i=await i),null!=i)return s(i,n)}return new Response("string"==typeof r.cause?r.cause:r.message,{headers:n.headers,status:r.status??500})};